# Архитектура бота

## Схема работы

```
┌─────────────┐
│  Пользователь│
│  (Telegram)  │
└──────┬───────┘
       │ 1. Отправляет файл
       ▼
┌──────────────────┐
│  Telegram Bot    │
│  (bot.js)        │
└──────┬───────────┘
       │ 2. Скачивает файл
       │    в /temp
       ▼
┌──────────────────┐
│  Локальное       │
│  хранилище       │
│  /temp/file.pdf  │
└──────┬───────────┘
       │ 3. Загружает на academi.cx
       ▼
┌──────────────────────────────┐
│  Academi.cx Integration      │
│                              │
│  Вариант А: Puppeteer        │
│  ┌────────────────────────┐  │
│  │ - Открывает браузер    │  │
│  │ - Загружает файл       │  │
│  │ - Ждет обработки       │  │
│  │ - Скачивает результат  │  │
│  └────────────────────────┘  │
│                              │
│  Вариант Б: HTTP API         │
│  ┌────────────────────────┐  │
│  │ - POST запрос с файлом │  │
│  │ - Получает ответ       │  │
│  │ - Скачивает по ссылке  │  │
│  └────────────────────────┘  │
└──────────────┬───────────────┘
               │ 4. Возвращает обработанный файл
               ▼
┌──────────────────┐
│  Локальное       │
│  хранилище       │
│  /temp/result.pdf│
└──────┬───────────┘
       │ 5. Отправляет пользователю
       ▼
┌─────────────┐
│  Пользователь│
│  (Telegram)  │
└─────────────┘
```

## Компоненты проекта

### 1. bot.js (Основной бот с Puppeteer)
**Назначение:** Полная автоматизация через браузер

**Плюсы:**
- Работает даже если нет API
- Может обходить защиту
- Видит все как пользователь

**Минусы:**
- Медленнее
- Требует больше ресурсов
- Нужен Chrome/Chromium

**Когда использовать:**
- Нет публичного API
- Сложная логика на сайте
- Нужна полная эмуляция пользователя

### 2. bot-http.js (HTTP версия)
**Назначение:** Прямые HTTP запросы к API

**Плюсы:**
- Быстрее
- Меньше ресурсов
- Проще отладка

**Минусы:**
- Нужен API endpoint
- Может не работать с защитой

**Когда использовать:**
- Есть API endpoint
- Простая загрузка файлов
- Нужна скорость

### 3. inspect-academi.js (Инспектор)
**Назначение:** Исследование структуры сайта

**Что делает:**
- Открывает браузер с DevTools
- Логирует все запросы
- Показывает элементы страницы
- Сохраняет HTML структуру

**Когда использовать:**
- Первая настройка
- Сайт изменился
- Нужно найти селекторы

### 4. test-token.js (Тест токена)
**Назначение:** Проверка Telegram токена

**Что делает:**
- Проверяет валидность токена
- Показывает информацию о боте
- Дает ссылку на бота

**Когда использовать:**
- Перед первым запуском
- При проблемах с подключением
- После создания нового бота

## Поток данных

### Входящий файл
```
Telegram API
    ↓
getFileLink() → URL файла
    ↓
axios.get() → Stream
    ↓
fs.writeStream() → Локальный файл
    ↓
/temp/timestamp_filename.ext
```

### Обработка на academi.cx

**Вариант Puppeteer:**
```
Локальный файл
    ↓
puppeteer.launch() → Браузер
    ↓
page.goto() → Открытие сайта
    ↓
fileInput.uploadFile() → Загрузка
    ↓
submitButton.click() → Отправка
    ↓
page.waitForSelector() → Ожидание результата
    ↓
downloadLink.href → URL результата
    ↓
axios.get() → Скачивание
    ↓
/temp/processed_filename.ext
```

**Вариант HTTP:**
```
Локальный файл
    ↓
FormData.append() → Форма
    ↓
axios.post() → POST запрос
    ↓
response.data → JSON с URL
    ↓
axios.get() → Скачивание
    ↓
/temp/processed_filename.ext
```

### Исходящий файл
```
/temp/processed_filename.ext
    ↓
bot.sendDocument() → Telegram API
    ↓
Пользователь получает файл
    ↓
fs.unlinkSync() → Удаление временных файлов
```

## Обработка ошибок

```
┌─────────────────┐
│  Любая операция │
└────────┬────────┘
         │
    try {│}
         │
         ├─ Успех → Продолжение
         │
         └─ Ошибка
            ↓
       catch (error)
            ↓
    console.error()
            ↓
    bot.sendMessage()
    "❌ Ошибка..."
            ↓
    Очистка временных файлов
```

## Безопасность

### Защита токена
```
.env файл (не в git)
    ↓
process.env.TELEGRAM_BOT_TOKEN
    ↓
Используется только в коде
```

### Изоляция файлов
```
Каждый файл: timestamp_filename
    ↓
Уникальное имя
    ↓
Автоматическое удаление после отправки
    ↓
Нет конфликтов между пользователями
```

## Масштабирование

### Текущая архитектура
- Один процесс
- Последовательная обработка
- Локальное хранилище

### Для высокой нагрузки

**Вариант 1: Очередь задач**
```
Telegram Bot
    ↓
Redis Queue
    ↓
Worker 1, Worker 2, Worker 3...
    ↓
Academi.cx
```

**Вариант 2: Микросервисы**
```
API Gateway
    ├─ Bot Service
    ├─ File Service
    ├─ Academi Service
    └─ Storage Service
```

**Вариант 3: Serverless**
```
Telegram Webhook
    ↓
AWS Lambda / Google Cloud Functions
    ↓
S3 / Cloud Storage
```

## Мониторинг

### Логирование
```javascript
console.log('Bot started');           // Старт
console.log('File uploaded');         // Загрузка
console.log('Processing...');         // Обработка
console.error('Error:', error);       // Ошибки
```

### Метрики
```javascript
stats = {
    processed: 0,      // Обработано файлов
    errors: 0,         // Ошибок
    avgTime: 0,        // Среднее время
    users: new Set()   // Уникальные пользователи
}
```

## Зависимости

```
node-telegram-bot-api
    ↓
Telegram Bot API
    ↓
Long Polling / Webhooks

axios
    ↓
HTTP клиент
    ↓
Скачивание/загрузка файлов

puppeteer
    ↓
Chrome DevTools Protocol
    ↓
Автоматизация браузера

form-data
    ↓
multipart/form-data
    ↓
Загрузка файлов
```

## Развертывание

### Локально
```bash
node bot.js
```

### PM2
```bash
pm2 start bot.js
pm2 save
```

### Docker
```dockerfile
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
CMD ["node", "bot.js"]
```

### Systemd
```ini
[Service]
ExecStart=/usr/bin/node /path/to/bot.js
Restart=always
```

## Производительность

### Узкие места
1. **Puppeteer** - медленный запуск браузера
2. **Academi.cx** - время обработки файла
3. **Telegram API** - лимиты на запросы

### Оптимизация
1. **Переиспользование браузера** - не закрывать между запросами
2. **Кэширование** - если файл уже обрабатывался
3. **Параллельная обработка** - несколько файлов одновременно

## Тестирование

### Ручное
```bash
npm test              # Проверка токена
npm run inspect       # Проверка сайта
npm start            # Запуск бота
```

### Автоматическое
```javascript
// Юнит-тесты
test('downloadFile', async () => {
    const file = await downloadFile(url, path);
    expect(fs.existsSync(path)).toBe(true);
});

// Интеграционные тесты
test('bot responds to /start', async () => {
    const response = await bot.sendMessage(chatId, '/start');
    expect(response).toBeDefined();
});
```

## Обслуживание

### Регулярные задачи
- Проверка логов
- Очистка /temp (если файлы остались)
- Обновление зависимостей
- Проверка селекторов (если сайт изменился)

### Резервное копирование
- .env файл (токен)
- Конфигурация
- Логи (опционально)
